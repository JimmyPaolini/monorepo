name: üßë‚Äçüíº Bundle Report

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bundle-report:
    name: üßë‚Äçüíº Bundle Report
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Pull Request
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üïã Setup Monorepo (Pull Request)
        uses: ./.github/actions/setup-monorepo

      - name: üì¶ Check Bundle Size (Pull Request)
        id: pr-bundle-size
        run: |
          # Run bundlesize on affected projects and capture output
          npx nx affected -t bundlesize --parallel=2 > bundle-size-pr.txt 2>&1 || true

          # Strip ANSI color codes and remove verbose Vite build file listings
          PULL_REQUEST_OUTPUT=$(cat bundle-size-pr.txt | \
            sed 's/\x1B\[[0-9;]*[JKmsu]//g' | \
            grep -v 'dist/application' | \
            grep -v 'dist/client' | \
            grep -v 'dist/server' | \
            grep -v '\.css$' | \
            grep -v '\.js$' | \
            grep -v 'rendering chunks' | \
            grep -v 'computing gzip size' | \
            grep -v 'modules transformed' || echo "No bundle size data available")

          echo "pull_request_output<<EOF" >> $GITHUB_OUTPUT
          echo "$PULL_REQUEST_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üì• Checkout Main Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          clean: false

      - name: üïã Setup Monorepo (Main Branch)
        uses: ./.github/actions/setup-monorepo

      - name: üì¶ Check Bundle Size (Main Branch)
        id: base-bundle-size
        run: |
          # Build and check bundle size for base branch
          npx nx affected -t bundlesize --parallel=2 --base=${{ github.base_ref }} --head=${{ github.base_ref }} > bundle-size-base.txt 2>&1 || true

          # Strip ANSI color codes and remove verbose Vite build file listings
          BASE_OUTPUT=$(cat bundle-size-base.txt | \
            sed 's/\x1B\[[0-9;]*[JKmsu]//g' | \
            grep -v 'dist/application' | \
            grep -v 'dist/client' | \
            grep -v 'dist/server' | \
            grep -v '\.css$' | \
            grep -v '\.js$' | \
            grep -v 'rendering chunks' | \
            grep -v 'computing gzip size' | \
            grep -v 'modules transformed' || echo "No bundle size data available")

          echo "base_output<<EOF" >> $GITHUB_OUTPUT
          echo "$BASE_OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üìä Analyze Bundle Size Changes
        id: analyze-changes
        env:
          PULL_REQUEST_OUTPUT: ${{ steps.pr-bundle-size.outputs.pull_request_output }}
          BASE_OUTPUT: ${{ steps.base-bundle-size.outputs.base_output }}
        run: |
          # Function to extract size in KB from size-limit output
          extract_sizes() {
            local output="$1"
            # Extract lines with "Package size:" and convert to KB
            echo "$output" | grep -oP 'Package size:\s+\K[0-9.]+\s+(KB|B|MB)' | while read size unit; do
              case $unit in
                B) echo "scale=2; $size / 1024" | bc ;;
                KB) echo "$size" ;;
                MB) echo "scale=2; $size * 1024" | bc ;;
              esac
            done | paste -sd+ - | bc 2>/dev/null || echo "0"
          }

          # Function to extract bundle names and sizes
          extract_bundle_data() {
            local output="$1"
            echo "$output" | awk '
              /name:/ { name=$2; for(i=3;i<=NF;i++) name=name" "$i }
              /Package size:/ {
                gsub(/,/, "", $3);
                size=$3;
                unit=$4;
                printf "%s: %s %s\n", name, size, unit
              }
            '
          }

          # Extract total sizes
          BASE_SIZE=$(extract_sizes "$BASE_OUTPUT")
          PR_SIZE=$(extract_sizes "$PULL_REQUEST_OUTPUT")

          echo "Base branch total: ${BASE_SIZE} KB"
          echo "Pull request total: ${PR_SIZE} KB"

          # Calculate difference if both have valid sizes
          if [ "$BASE_SIZE" != "0" ] && [ "$PR_SIZE" != "0" ]; then
            DIFF=$(echo "scale=2; $PR_SIZE - $BASE_SIZE" | bc)
            PERCENT=$(echo "scale=2; ($DIFF / $BASE_SIZE) * 100" | bc)

            echo "size_diff=${DIFF}" >> $GITHUB_OUTPUT
            echo "size_percent=${PERCENT}" >> $GITHUB_OUTPUT
            echo "base_size=${BASE_SIZE}" >> $GITHUB_OUTPUT
            echo "pr_size=${PR_SIZE}" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT

            echo "Difference: ${DIFF} KB (${PERCENT}%)"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No valid bundle size data to compare"
          fi

          # Extract detailed bundle data
          BASE_BUNDLES=$(extract_bundle_data "$BASE_OUTPUT")
          PR_BUNDLES=$(extract_bundle_data "$PULL_REQUEST_OUTPUT")

          echo "base_bundles<<BUNDLE_EOF" >> $GITHUB_OUTPUT
          echo "$BASE_BUNDLES" >> $GITHUB_OUTPUT
          echo "BUNDLE_EOF" >> $GITHUB_OUTPUT

          echo "pr_bundles<<BUNDLE_EOF" >> $GITHUB_OUTPUT
          echo "$PR_BUNDLES" >> $GITHUB_OUTPUT
          echo "BUNDLE_EOF" >> $GITHUB_OUTPUT

      - name: üí¨ Comment Report on Pull Request
        if: steps.analyze-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        env:
          BASE_SIZE: ${{ steps.analyze-changes.outputs.base_size }}
          PR_SIZE: ${{ steps.analyze-changes.outputs.pr_size }}
          SIZE_DIFF: ${{ steps.analyze-changes.outputs.size_diff }}
          SIZE_PERCENT: ${{ steps.analyze-changes.outputs.size_percent }}
          BASE_BUNDLES: ${{ steps.analyze-changes.outputs.base_bundles }}
          PR_BUNDLES: ${{ steps.analyze-changes.outputs.pr_bundles }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const baseSize = process.env.BASE_SIZE;
            const prSize = process.env.PR_SIZE;
            const sizeDiff = parseFloat(process.env.SIZE_DIFF);
            const sizePercent = parseFloat(process.env.SIZE_PERCENT);
            const baseBundles = process.env.BASE_BUNDLES;
            const prBundles = process.env.PR_BUNDLES;

            // Determine status emoji
            let statusEmoji = '‚úÖ';
            let statusText = 'No change';
            if (sizeDiff > 0) {
              if (sizePercent > 5) {
                statusEmoji = '‚ùå';
                statusText = 'Increased significantly';
              } else {
                statusEmoji = '‚ö†Ô∏è';
                statusText = 'Increased slightly';
              }
            } else if (sizeDiff < 0) {
              statusEmoji = '‚úÖ';
              statusText = 'Decreased';
            }

            const diffSign = sizeDiff > 0 ? '+' : '';

            const comment = `## üì¶ Bundle Size Report

            ${statusEmoji} **${statusText}**: ${diffSign}${sizeDiff.toFixed(2)} KB (${diffSign}${sizePercent.toFixed(2)}%)

            | Branch | Total Size |
            |--------|-----------|
            | **${context.payload.pull_request.base.ref}** (base) | ${baseSize} KB |
            | **${context.payload.pull_request.head.ref}** (PR) | ${prSize} KB |
            | **Difference** | ${diffSign}${sizeDiff.toFixed(2)} KB (${diffSign}${sizePercent.toFixed(2)}%) |

            <details>
            <summary>üìã Bundle Breakdown - Base Branch</summary>

            \`\`\`
            ${baseBundles}
            \`\`\`
            </details>

            <details>
            <summary>üìã Bundle Breakdown - Pull Request</summary>

            \`\`\`
            ${prBundles}
            \`\`\`
            </details>

            <details>
            <summary>üìä Guidelines</summary>

            - ‚úÖ **Good**: Bundle size decreased or stayed the same
            - ‚ö†Ô∏è **Warning**: Bundle size increased by less than 5%
            - ‚ùå **Critical**: Bundle size increased by more than 5%

            **Optimization Tips:**
            - Use dynamic imports for large dependencies
            - Enable tree-shaking for unused exports
            - Optimize images and assets
            - Lazy load non-critical components
            - Use route-based code splitting
            </details>

            ---
            *Updated automatically when you push new commits.*`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Bundle Size')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: comment
              });
            }
