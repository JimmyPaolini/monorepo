# Security Audit Workflow
# Purpose: Combined security audit running four steps sequentially:
#   - ğŸ” Gitleaks secret scanning (push to main + PRs)
#   - ğŸ•µï¸ pnpm dependency audit (push to main + PRs + weekly schedule)
#   - ğŸ³ Trivy Docker scanning for caelundas image (only on Dockerfile changes)
#   - ğŸ—ï¸ Trivy IaC scanning for Terraform configs (only on terraform/** changes)
# @see https://github.com/gitleaks/gitleaks-action
# @see https://github.com/aquasecurity/trivy-action

name: ğŸ•µï¸ Security Audit

on:
  push:
    branches:
      - main
  pull_request:
  schedule:
    - cron: 0 6 * * 1 # Weekly Monday 6am UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  security-audit:
    name: ğŸ•µï¸ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸš° Gitleaks Check
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ•‹ Setup monorepo
        uses: ./.github/actions/setup-monorepo

      - name: ğŸ“š Dependency Audit
        run: pnpm exec nx affected --target=dependency-audit --parallel=3

      - name: ğŸ” Check Changes
        if: github.event_name != 'schedule'
        id: paths
        # paths-filter has no diff context on schedule events, so Trivy steps
        # fall back to the `github.event_name == 'schedule'` condition instead
        uses: dorny/paths-filter@v3
        with:
          filters: |
            dockerfile:
              - applications/caelundas/Dockerfile
            terraform:
              - infrastructure/terraform/**

      - name: ğŸ³ Build caelundas Docker image
        if: github.event_name == 'schedule' || steps.paths.outputs.dockerfile == 'true'
        run: docker build --target=caelundas:scan -f applications/caelundas/Dockerfile .

      - name: ğŸ›¡ï¸ Trivy Docker Scan
        if: github.event_name == 'schedule' || steps.paths.outputs.dockerfile == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: caelundas:scan
          format: table
          severity: CRITICAL,HIGH
          exit-code: 1

      - name: ğŸ—ï¸ Trivy Infrastructure Scan
        if: github.event_name == 'schedule' || steps.paths.outputs.terraform == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: infrastructure/terraform
          format: table
          severity: CRITICAL,HIGH
          exit-code: 1
